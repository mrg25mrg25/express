jwt authentication
// JWT ржЯрзЛржХрзЗржи ржмрж╛ржирж╛ржирзЛрж░ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЗржиржкрзЛрж░рзНржЯ ржХрж░рж▓рж╛ржо
const jwt = require('jsonwebtoken');

// Express ржПрж░ ржЬржирзНржп JWT ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛рж░ middleware ржЗржиржкрзЛрж░рзНржЯ ржХрж░рж▓рж╛ржо
const expressJwt = require('express-jwt');

// ржЯрзЛржХрзЗржи ржмрж╛ржирж╛рждрзЗ ржПржмржВ ржпрж╛ржЪрж╛ржЗ ржХрж░рждрзЗ ржПржЗ рж╕рж┐ржХрзНрж░рзЗржЯ ржЪрж╛ржмрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржм
const SECRET = 'your-jwt-secret';

// ржЗржЙржЬрж╛рж░ рж▓ржЧржЗржи ржХрж░рж╛рж░ рж╕ржорзЯ ржЯрзЛржХрзЗржи рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржмрзЗ
app.post('/login', (req, res) => {
  // ржПржЦрж╛ржирзЗ ржзрж░рзЗ ржирж┐ржЪрзНржЫрж┐ ржЗржЙржЬрж╛рж░ ржарж┐ржХ ржЖржЫрзЗ (ржмрж╛рж╕рзНрждржмрзЗ ржбрж╛ржЯрж╛ржмрзЗржЬ ржерзЗржХрзЗ ржЪрзЗржХ ржХрж░рждрзЗ рж╣рзЯ)
  const user = { id: 1, username: 'admin' };

  // ржЗржЙржЬрж╛рж░рзЗрж░ рждржерзНржп ржжрж┐рзЯрзЗ JWT ржЯрзЛржХрзЗржи рждрзИрж░рж┐ ржХрж░рж▓рж╛ржо, ржпрзЗржЯрж╛ рзз ржШржгрзНржЯрж╛ ржЪрж▓ржмрзЗ
  const token = jwt.sign(user, SECRET, { expiresIn: '1h' });

  // ржЯрзЛржХрзЗржи ржЗржЙржЬрж╛рж░ржХрзЗ рж░рзЗрж╕ржкржирзНрж╕ рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛ржарж┐рзЯрзЗ ржжрж┐рж▓рж╛ржо
  res.json({ token });
});

// ржПржЗ рж░рж╛ржЙржЯржЯрж╛ рж╕рж┐ржХрж┐ржЙрж░, ржПржЦрж╛ржирзЗ ржЯрзЛржХрзЗржи ржЫрж╛рзЬрж╛ ржХрзЗржЙ ржврзБржХрждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛
app.get('/protected', expressJwt({ secret: SECRET }), (req, res) => {
  // ржЯрзЛржХрзЗржи рж╕ржарж┐ржХ рж╣рж▓рзЗ ржПржЗ ржбрж╛ржЯрж╛ ржжрзЗржЦрж╛ржирзЛ рж╣ржмрзЗ
  res.send('Protected data');
});

// ржпржжрж┐ ржЯрзЛржХрзЗржи ржнрзБрж▓ рж╣рзЯ ржмрж╛ ржирж╛ ржерж╛ржХрзЗ, рждрж╛рж╣рж▓рзЗ ржПржЦрж╛ржирзЗ ржПрж░рж░ ржзрж░ржмрзЛ
app.use((err, req, res, next) => {
  // ржпржжрж┐ ржПрж░рж░ рж╣рзЯ ржЯрзЛржХрзЗржи рж╕ржВржХрзНрж░рж╛ржирзНржд, рждрж╛рж╣рж▓рзЗ 401 ржжрж┐рзЯрзЗ ржЬрж╛ржирж┐рзЯрзЗ ржжрж┐ржм
  if(err.name === 'UnauthorizedError') {
    res.status(401).send('Invalid token');
  }
});
//тАж..............тАжтАж





// express-rate-limit

// JWT ржЯрзЛржХрзЗржи ржмрж╛ржирж╛ржирзЛрж░ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЗржиржкрзЛрж░рзНржЯ ржХрж░рж▓рж╛ржо
const jwt = require('jsonwebtoken');

// Express ржПрж░ ржЬржирзНржп JWT ржпрж╛ржЪрж╛ржЗ ржХрж░рж╛рж░ middleware ржЗржиржкрзЛрж░рзНржЯ ржХрж░рж▓рж╛ржо
const expressJwt = require('express-jwt');

// Rate limit middleware ржЗржиржкрзЛрж░рзНржЯ ржХрж░рж▓рж╛ржо
const rateLimit = require('express-rate-limit');

// ржЯрзЛржХрзЗржи ржмрж╛ржирж╛рждрзЗ ржПржмржВ ржпрж╛ржЪрж╛ржЗ ржХрж░рждрзЗ ржПржЗ рж╕рж┐ржХрзНрж░рзЗржЯ ржЪрж╛ржмрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржм
const SECRET = 'your-jwt-secret';

// Rate limiter рждрзИрж░рж┐ ржХрж░рж▓рж╛ржо: рзз ржорж┐ржирж┐ржЯрзЗ ржПржХржЬржи ржЗржЙржЬрж╛рж░ рзлржмрж╛рж░ рж░рж┐ржХрзБрзЯрзЗрж╕рзНржЯ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
const limiter = rateLimit({
  windowMs: 1 * 60 * 1000, // рзз ржорж┐ржирж┐ржЯ
  max: 5, // рж╕рж░рзНржмрзЛржЪрзНржЪ рзл ржмрж╛рж░
  message: 'Too many requests, please try again later.' // рж▓рж┐ржорж┐ржЯ ржкрзЗрж░рж╛рж▓рзЗ ржПржЗ ржорзЗрж╕рзЗржЬ ржжрж┐ржмрзЗ
});

// рж▓ржЧржЗржи рж░рж╛ржЙржЯрзЗ рж░рзЗржЯ рж▓рж┐ржорж┐ржЯ ржЕрзНржпрж╛ржкрзНрж▓рж╛ржЗ ржХрж░рж▓рж╛ржо
app.post('/login', limiter, (req, res) => {
  // ржПржЦрж╛ржирзЗ ржзрж░рзЗ ржирж┐ржЪрзНржЫрж┐ ржЗржЙржЬрж╛рж░ ржарж┐ржХ ржЖржЫрзЗ (ржмрж╛рж╕рзНрждржмрзЗ ржбрж╛ржЯрж╛ржмрзЗржЬ ржерзЗржХрзЗ ржЪрзЗржХ ржХрж░рждрзЗ рж╣рзЯ)
  const user = { id: 1, username: 'admin' };

  // ржЗржЙржЬрж╛рж░рзЗрж░ рждржерзНржп ржжрж┐рзЯрзЗ JWT ржЯрзЛржХрзЗржи рждрзИрж░рж┐ ржХрж░рж▓рж╛ржо, ржпрзЗржЯрж╛ рзз ржШржгрзНржЯрж╛ ржЪрж▓ржмрзЗ
  const token = jwt.sign(user, SECRET, { expiresIn: '1h' });

  // ржЯрзЛржХрзЗржи ржЗржЙржЬрж╛рж░ржХрзЗ рж░рзЗрж╕ржкржирзНрж╕ рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛ржарж┐рзЯрзЗ ржжрж┐рж▓рж╛ржо
  res.json({ token });
});

// ржПржЗ рж░рж╛ржЙржЯржЯрж╛ рж╕рж┐ржХрж┐ржЙрж░, ржПржЦрж╛ржирзЗ ржЯрзЛржХрзЗржи ржЫрж╛рзЬрж╛ ржХрзЗржЙ ржврзБржХрждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛
app.get('/protected', expressJwt({ secret: SECRET, algorithms: ['HS256'] }), (req, res) => {
  // ржЯрзЛржХрзЗржи рж╕ржарж┐ржХ рж╣рж▓рзЗ ржПржЗ ржбрж╛ржЯрж╛ ржжрзЗржЦрж╛ржирзЛ рж╣ржмрзЗ
  res.send('Protected data');
});

// ржпржжрж┐ ржЯрзЛржХрзЗржи ржнрзБрж▓ рж╣рзЯ ржмрж╛ ржирж╛ ржерж╛ржХрзЗ, рждрж╛рж╣рж▓рзЗ ржПржЦрж╛ржирзЗ ржПрж░рж░ ржзрж░ржмрзЛ
app.use((err, req, res, next) => {
  // ржпржжрж┐ ржПрж░рж░ рж╣рзЯ ржЯрзЛржХрзЗржи рж╕ржВржХрзНрж░рж╛ржирзНржд, рждрж╛рж╣рж▓рзЗ 401 ржжрж┐рзЯрзЗ ржЬрж╛ржирж┐рзЯрзЗ ржжрж┐ржм
  if(err.name === 'UnauthorizedError') {
    res.status(401).send('Invalid token');
  }
});
//...................






// Mongoose рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЗржиржкрзЛрж░рзНржЯ ржХрж░рж▓рж╛ржо (MongoDB ржПрж░ рж╕рж╛ржерзЗ ржХрж╛ржЬ ржХрж░рж╛рж░ ржЬржирзНржп)
const mongoose = require('mongoose');

// MongoDB ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗрж░ рж╕рж╛ржерзЗ ржХрж╛ржирзЗржХрж╢ржи ржХрж░рж▓рж╛ржо
mongoose.connect('mongodb://localhost:27017/mydb', {
  useNewUrlParser: true,        // ржирждрзБржи URL ржкрж╛рж░рзНрж╕рж╛рж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЛ
  useUnifiedTopology: true      // ржЗржЙржирж┐ржлрж╛ржЗржб ржЯржкрзЛрж▓ржЬрж┐ ржЪрж╛рж▓рзБ ржХрж░ржмрзЛ (ржирждрзБржи рж╕рж┐рж╕рзНржЯрзЗржо)
})
.then(() => console.log('MongoDB connected'))  // ржХрж╛ржирзЗржХрж╢ржи рж╕ржлрж▓ рж╣рж▓рзЗ ржорзЗрж╕рзЗржЬ ржжрж┐ржмрзЗ
.catch(err => console.error('Connection error:', err)); // ржХрж╛ржирзЗржХрж╢ржирзЗ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЗ ржПрж░рж░ ржжрзЗржЦрж╛ржмрзЗ

// ржПржХржЯрж┐ ржЗржЙржЬрж╛рж░ ржоржбрзЗрж▓ ржмрж╛ржирж╛рж▓рж╛ржо (Schema ржЫрж╛рзЬрж╛ржУ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ рж╕рж░рж▓рждрж╛рж░ ржЬржирзНржп)
const User = mongoose.model('User', {
  name: String,   // ржЗржЙржЬрж╛рж░рзЗрж░ ржирж╛ржо рж╕рзНржЯрзЛрж░ рж╣ржмрзЗ
  email: String   // ржЗржЙржЬрж╛рж░рзЗрж░ ржЗржорзЗржЗрж▓ рж╕рзНржЯрзЛрж░ рж╣ржмрзЗ
});

// POST рж░рж╛ржЙржЯ рждрзИрж░рж┐ ржХрж░рж▓рж╛ржо: ржирждрзБржи ржЗржЙржЬрж╛рж░ ржмрж╛ржирж╛ржирзЛрж░ ржЬржирзНржп
app.post('/users', async (req, res) => {
  try {
    // ржЗржЙржЬрж╛рж░ ржЕржмржЬрзЗржХрзНржЯ рждрзИрж░рж┐ ржХрж░рж▓рж╛ржо рж░рж┐ржХрзБрзЯрзЗрж╕рзНржЯ ржерзЗржХрзЗ ржкрж╛ржУрзЯрж╛ ржбрзЗржЯрж╛ ржжрж┐рзЯрзЗ
    const user = new User(req.body);

    // ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ рж╕рзЗржЗржн ржХрж░рж▓рж╛ржо
    await user.save();

    // рзирзжрзз ржорж╛ржирзЗ: Created. рж╕рзЗржЗржн рж╕ржлрж▓ рж╣рж▓рзЗ ржЗржЙржЬрж╛рж░ржХрзЗ рж░рзЗрж╕ржкржирзНрж╕ рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛ржарж╛рж▓рж╛ржо
    res.status(201).send(user);
  } catch (err) {
    // ржХрзЛржирзЛ ржПрж░рж░ рж╣рж▓рзЗ рзкрзжрзж (Bad Request) ржжрж┐рзЯрзЗ ржПрж░рж░ ржкрж╛ржарж╛рж▓рж╛ржо
    res.status(400).send(err);
  }
});
///////////////////////////////





 

// supertest рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржжрж┐рзЯрзЗ HTTP рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛ржирзЛрж░ ржЬржирзНржп request ржлрж╛ржВрж╢ржи ржЖржирж╛ рж╣рзЯрзЗржЫрзЗ
const request = require('supertest');
// ржЕрзНржпрж╛ржкрзЗрж░ ржорзЗржЗржи ржлрж╛ржЗрж▓ (ржпрзЗржЦрж╛ржирзЗ express app ржмрж╛ржирж╛ржирзЛ рж╣рзЯ) ржЗржоржкрзЛрж░рзНржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ
const app = require('../app');

// describe ржмрзНрж▓ржХрзЗрж░ ржнрж┐рждрж░рзЗ 'GET /api/users' рж░рзБржЯ ржПрж░ ржЯрзЗрж╕рзНржЯ рж╢рзБрж░рзБ
describe('GET /api/users', () => {

  // ржПржЗ ржЯрзЗрж╕рзНржЯржЯрж╛ ржЪрзЗржХ ржХрж░рзЗ рж╕ржм ржЗржЙржЬрж╛рж░ ржлрж┐рж░рж╛рзЯ ржХрж┐ржирж╛
  it('should return all users', async () => {
    const res = await request(app)         // app ржПрж░ ржЙржкрж░ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛ржирзЛ
      .get('/api/users')                   // GET рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ
      .expect(200);                        // HTTP status 200 ржЖрж╢рж╛ ржХрж░рж╛ рж╣рзЯ

    expect(Array.isArray(res.body)).toBeTruthy(); // рж░рзЗрж╕ржкржирзНрж╕ ржмржбрж┐ ржПржХржЯрж╛ array ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рж╛ рж╣рзЯ
  });

  // ржПржЗ ржЯрзЗрж╕рзНржЯржЯрж╛ ржЪрзЗржХ ржХрж░рзЗ ржирждрзБржи ржЗржЙржЬрж╛рж░ рждрзИрж░рж┐ рж╣рзЯ ржХрж┐ржирж╛
  it('should create a new user', async () => {
    const res = await request(app)             // app ржПрж░ ржЙржкрж░ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛ржирзЛ
      .post('/api/users')                      // POST рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ
      .send({ name: 'John', email: 'john@example.com' }) // ржЗржЙржЬрж╛рж░ ржбрзЗржЯрж╛ ржкрж╛ржарж╛ржирзЛ
      .expect(201);                            // HTTP status 201 ржЖрж╢рж╛ ржХрж░рж╛ рж╣рзЯ (Created)

    expect(res.body.name).toBe('John');        // рж░рзЗрж╕ржкржирзНрж╕ ржмржбрж┐рждрзЗ name ржарж┐ржХ ржЖржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рж╛ рж╣рзЯ
  });

});
////////////////////






// Express ржлрзНрж░рзЗржоржУрзЯрж╛рж░рзНржХ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ ржзрж░рзЗ ржирж┐ржЪрзНржЫрж┐
const express = require('express');   // Express ржЗржоржкрзЛрж░рзНржЯ ржХрж░рж╛
const app = express();                // ржЕрзНржпрж╛ржк рждрзИрж░рж┐ ржХрж░рж╛

// Health check endpoint рждрзИрж░рж┐
app.get('/health', (req, res) => {        // ржпржЦржи ржХрзЗржЙ '/health' рж░рж╛ржЙржЯрзЗ GET рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛ржмрзЗ
  res.status(200).send('Server is healthy'); // рждржЦржи рзирзжрзж status ржжрж┐рзЯрзЗ "Server is healthy" ржкрж╛ржарж╛ржмрзЗ
});

// рж╕рж╛рж░рзНржнрж╛рж░ ржЪрж╛рж▓рзБ ржХрж░рж╛
app.listen(3000, () => {
  console.log('Server is running on port 3000');
});
/////////////////ЁЯлгЁЯлгЁЯлгЁЯлг











